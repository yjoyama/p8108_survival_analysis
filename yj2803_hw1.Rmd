---
title: "Homework1"
author: "Yuki Joyama"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, message = F, warning = F)

library(tidyverse)
library(ggplot2)
library(knitr)
library(km.ci)
```
# 1. Exponential Density and Survival-related Functions
(a) Let $\hat{\lambda}$ be the maximum likelihood estimator of the parameter $\lambda$.  
For relapse time:  
$\hat{\lambda}=\frac{6}{5+8+12+24+32+17+16+17+19+30}\approx0.033$  
This indicates that the rate of relapse is about 3.33% per month.  
For relapse time:  
$\hat{\lambda}=\frac{3}{10+12+15+33+45+28+16+17+19+30}\approx0.013$  
This indicates that the rate of death is about 1.33% per month. 

(b)   
i. Mean is $\int_0^\infty t\lambda e^{-\lambda t} dt=\frac{1}{\lambda}$ and I will use $\hat{\lambda}$ to derive the following values.  
Mean time to relapse:  
$\frac{1}{0.033}\approx30.303$ months
Mean survival time:  
$\frac{1}{0.013}\approx76.923$ months  

ii. Median is $0.5=e^{-\lambda \tau} \Rightarrow\tau = \frac{-log(0.5)}{\lambda}$. By $\hat{\lambda}$,  
Median time to relapse:  
$\frac{-log(0.5)}{0.033}\approx21.004$ months
Median survival time:  
$\frac{-log(0.5)}{0.013}\approx53.319$ months    
```{r}
# relapse survival function
lambda_rl = 6/(5+8+12+24+32+17+16+17+19+30)
sr12 = exp(-lambda_rl*12)
sr24 = exp(-lambda_rl*24)

# death survival function
lambda_d = 3/(10+12+15+33+45+28+16+17+19+30)
sd12 = exp(-lambda_d*12)
sd24 = exp(-lambda_d*24)
```
iii. The survival function of exponential distribution is $S(t)=e^{-\lambda t}$. 
For relapse:  
$S_R(12)=e^{-0.033*12}=$ `r round(sr12, 3)`   
$S_R(24)=e^{-0.033*24}=$ `r round(sr24, 3)`  
For death:  
$S_D(12)=e^{-0.013*12}=$ `r round(sd12, 3)`   
$S_D(24)=e^{-0.013*24}=$ `r round(sd24, 3)`

```{r}
# relapse F(t)
fr12 = lambda_rl * 12
fr24 = lambda_rl * 24

# death F(t)
fd12 = lambda_d * 12
fd24 = lambda_d * 24
```

iv. The cumulative probabilities can be calculated as: $F(t) = \int_0^t \lambda(u) du = \lambda t$  
For relapse:  
$F_R(12)=0.033\times12=$ `r round(fr12, 3)`   
$F_R(24)=0.033\times24$ `r round(fr24, 3)`  
For death:  
$F_D(12)=0.013\times12=$ `r round(fd12, 3)`   
$F_D(24)=0.013\times24=$ `r round(fd24, 3)`

v. The conditional probability can be expressed as $P(T>24|T>12)=\frac{S_R(24)}{S_R(12)}=$ `r round(sr24/sr12, 3)`  
It is the same as what we observed in (iii) $S_R(12)$. This means that the conditional probability of being relapse-free after 2 years given that one has remained relapse-free for at least 1 year simplifies to the survival function for the remaining time period (memoryless property of the exponential distribution).

(c) We can use Kaplan-Meier estimator to estimate median time to relapse. I will calculate them using R. 
```{r echo=T}
library(survival)
library(ggsurvfit)

# set up data
df1 <- data.frame(
  relapse_time = c(5, 8, 12, 24, 32, 17, 16, 17, 19, 30),
  relapse_censored = c(1, 1, 1, 1, 1, 1, 0, 0, 0, 0) # 1: event, 0: censored
)

# fit KM curve
relapse_surv <- Surv(df1$relapse_time, df1$relapse_censored)
relapse_km <- survfit(relapse_surv ~ 1)
relapse_km |> 
  ggsurvfit() 
```
This tells us that the median time $\tau$ s.t. $\hat{S}_R(\tau) \leq 0.50$ is 24 months.  
Meanwhile, we cannot estimate median time to death because the survival probability does not go below 0.50.

# 2. Kaplan-Meier Survival Estimate
(a) I will make a table with a row for every death or censoring time.  
$t_j$: distinct death or censoring times  
$d_j$: the number of death at $t_j$  
$r_j$: the number of individuals at risk right before the $j$-th death time  
$c_j$: the number of censored observations between the $j$-th and $(j+1)$-st death time   

|$t_j$|$d_j$|$c_j$|$r_j$|$1-(d_j/r_j)$|$\hat{S}(t_j)$|
|--------|-----|-----|-----|-------------|-----------------|
|2|1|0|17|`r round(1-1/17,3)`|`r round(1-1/17,3)`|
|3|1|0|16|`r round(1-1/16,3)`|`r round((1-1/17)*(1-1/16),3)`|
|4|1|0|15|`r round(1-1/15,3)`|`r round((1-1/17)*(1-1/16)*(1-1/15),3)`|
|12|1|0|14|`r round(1-1/14,3)`|`r round((1-1/17)*(1-1/16)*(1-1/15)*(1-1/14),3)`|
|22|1|0|13|`r round(1-1/13,3)`|`r round((1-1/17)*(1-1/16)*(1-1/15)*(1-1/14)*(1-1/13),3)`|
|48|1|0|12|`r round(1-1/12,3)`|`r round((1-1/17)*(1-1/16)*(1-1/15)*(1-1/14)*(1-1/13)*(1-1/12),3)`|
|51|0|1|11|1|`r round((1-1/17)*(1-1/16)*(1-1/15)*(1-1/14)*(1-1/13)*(1-1/12),3)`|
|56|0|1|10|1|`r round((1-1/17)*(1-1/16)*(1-1/15)*(1-1/14)*(1-1/13)*(1-1/12),3)`|
|80|1|0|9|`r round(1-1/9,3)`|`r round((1-1/17)*(1-1/16)*(1-1/15)*(1-1/14)*(1-1/13)*(1-1/12)*(1-1/9),3)`|
|85|1|0|8|`r round(1-1/8,3)`|`r round((1-1/17)*(1-1/16)*(1-1/15)*(1-1/14)*(1-1/13)*(1-1/12)*(1-1/9)*(1-1/8),3)`|
|90|1|0|7|`r round(1-1/7,3)`|`r round((1-1/17)*(1-1/16)*(1-1/15)*(1-1/14)*(1-1/13)*(1-1/12)*(1-1/9)*(1-1/8)*(1-1/7),3)`|
|94|0|1|6|1|`r round((1-1/17)*(1-1/16)*(1-1/15)*(1-1/14)*(1-1/13)*(1-1/12)*(1-1/9)*(1-1/8)*(1-1/7),3)`|
|160|1|0|5|`r round(1-1/5,3)`|`r round((1-1/17)*(1-1/16)*(1-1/15)*(1-1/14)*(1-1/13)*(1-1/12)*(1-1/9)*(1-1/8)*(1-1/7)*(1-1/5),3)`|
|171|1|0|4|`r round(1-1/4,3)`|`r round((1-1/17)*(1-1/16)*(1-1/15)*(1-1/14)*(1-1/13)*(1-1/12)*(1-1/9)*(1-1/8)*(1-1/7)*(1-1/5)*(1-1/4),3)`|
|180|1|1|3|`r round(1-1/3,3)`|`r round((1-1/17)*(1-1/16)*(1-1/15)*(1-1/14)*(1-1/13)*(1-1/12)*(1-1/9)*(1-1/8)*(1-1/7)*(1-1/5)*(1-1/4)*(1-1/3),3)`|
|238|1|0|1|0|0|

(b) I will use R to calculate $\hat{S}(t)$ and their pointwise 95% confidence intervals using the "log-log" approach ad the linear approach.  
```{r echo=T}
# set up data
df2 <- data.frame(
  t = c(2,3,4,12,22,48,51,56,80,85,90,94,160,171,180,180,238),
  c = c(1,1,1,1,1,1,0,0,1,1,1,0,1,1,1,0,1) # 1: event, 0: censored
)

# fit KM curve
surv <- Surv(df2$t, df2$c)
km <- survfit(surv ~ 1)

# log-log approach to obtain 95%CI 
l_loglog <- km.ci(km, method = "loglog")$lower
u_loglog <- km.ci(km, method = "loglog")$upper

# linear approach to obtain 95%CI 
l_linear <- km.ci(km, method = "linear")$lower
u_linear <- km.ci(km, method = "linear")$upper

# Create a table
tb <- data.frame(
  t = round(km$time,3), # time
  st = round(km$surv,3), # survival
  l_loglog = round(l_loglog, 3),
  u_loglog = round(u_loglog, 3),
  l_linear = round(l_linear, 3),
  u_linear = round(u_linear, 3)
)
kable(tb, col.names = c("t", "S(t)", "Lower 95%CI (log-log)", "Upper 95%CI (log-log)", "Lower 95%CI (linear)", "Upper 95%CI (linear)"))
```

Log-log approach returns CIs within $[0,1]$, but linear approach returns some values outside $[0,1]$.

(c)


